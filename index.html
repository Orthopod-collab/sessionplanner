<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Surgical Session Planner</title>
<style>
  :root{
    --bg1:#1a1f2d; --bg2:#221b36; --bg3:#1e2940;
    --card:#121825; --text:#e8ebf1; --muted:#a8b1c4; --border:#24304a; --head:#151c2b;
    --pill:#1c2438; --pill-text:#d6dcff; --chip:#1d2740; --chip-border:#2b3858;
    --grad:linear-gradient(90deg,#c084fc 0%,#8b5cf6 50%,#60a5fa 100%);
    --grad-soft:linear-gradient(135deg, rgba(192,132,252,.15), rgba(96,165,250,.15));
    --hover:#202a42; --accent:#c084fc; --accent2:#60a5fa; --ring:rgba(139,92,246,.35);
    --hit:#312e81; --hit-text:#c7d2fe;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}
  header{background:rgba(10,12,20,.85);backdrop-filter:saturate(140%) blur(6px);color:#fff;padding:18px;font-weight:800;letter-spacing:.3px;font-size:1.05rem}
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 56px)}
  .side{border-right:1px solid var(--border);background:rgba(14,18,30,.7);backdrop-filter:blur(6px);padding:12px;display:grid;align-content:start;gap:12px}
  .tab{border:1px solid var(--border);background:#141a2a;color:#d4dcf2;padding:12px;border-radius:12px;font-weight:800;cursor:pointer;text-align:left;transition:.15s}
  .tab:hover{border-color:#314166;background:#171f33}
  .tab.active{background:linear-gradient(180deg,#1b1a32,#141b2b);color:#fff;border-color:#3a2f71;box-shadow:0 0 0 2px rgba(124,58,237,.25) inset}
  main{padding:16px}
  .card{background:linear-gradient(180deg,var(--card),#0f1523);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
  h2{margin:0 0 10px;font-size:1rem;font-weight:900;background:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent}
  .stack{display:grid;gap:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:grid;gap:6px;font-size:.95rem;font-weight:800;color:#dbe5ff}
  select,textarea,input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0e1524;color:#e8ebf1;font-size:1rem;outline:none;transition:.15s}
  select:focus,textarea:focus,input[type="text"]:focus{border-color:#3b82f6;box-shadow:0 0 0 4px var(--ring)}
  ::placeholder{color:#7f8698}
  .btn{padding:12px 16px;border-radius:12px;border:0;background:var(--grad);color:#fff;font-weight:900;cursor:pointer;transition:.15s}
  .btn:hover{filter:brightness(1.05)}
  .btn.secondary{background:#10182a;border:1px solid var(--border)}
  .btn.secondary:hover{background:#152038}
  .pill{font-size:.78rem;padding:6px 10px;background:var(--pill);color:var(--pill-text);border:1px solid #2b3654;border-radius:999px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}.side{grid-auto-flow:column;grid-auto-columns:1fr;overflow:auto}.grid2{grid-template-columns:1fr}}
  .chips{display:flex;gap:8px;flex-wrap:wrap;padding:8px;border:1px solid var(--border);border-radius:12px;background:#0e1524;min-height:52px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:var(--chip);border:1px solid var(--chip-border);border-radius:999px;font-size:.9rem;color:#dce4ff}
  .chip .x{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;background:#212a46;border-radius:999px;font-weight:900;cursor:pointer;color:#aab8ff}
  .chip-input{border:none;outline:none;flex:1;min-width:140px;font-size:.95rem;padding:6px;color:#e8ebf1;background:transparent}
  .table-wrap{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#0f1629}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:.95rem;color:#e8ebf1}
  thead th{background:var(--head);padding:12px 14px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1;color:#d2dbf5;font-weight:900}
  tbody td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:top}
  .grp{background:#151d31;font-weight:900;cursor:pointer;transition:background .15s,color .15s,box-shadow .2s}
  .grp:hover{background:var(--hover);color:var(--accent);box-shadow:inset 0 0 0 999px var(--grad-soft)}
  .grp .caret{display:inline-block;width:0;height:0;margin-right:10px;border-left:6px solid #a8b1c4;border-top:5px solid transparent;border-bottom:5px solid transparent;transform:rotate(-90deg);transition:.2s}
  .grp.open .caret{border-left-color:#c084fc;transform:rotate(0deg)}
  /* Keep TBODY layout to preserve column alignment; hide rows when collapsed  */
  .subrows tr{display:none}
  .subrows.open tr{display:table-row}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:600px){.actions{display:grid;grid-template-columns:1fr 1fr;gap:6px}.actions .btn{padding:8px 10px;font-size:.9rem}}
  mark{background:var(--hit);color:var(--hit-text);border-radius:4px;padding:0 3px}

  /* Animated AI assistant */
  .assistant{margin-top:8px;border:1px solid var(--border);border-radius:16px;background:#141a2a;padding:12px;display:grid;gap:10px;align-content:end}
  .assistant-avatar{position:relative;width:150px;height:150px;justify-self:center}
  .assistant-bubble{position:absolute;left:50%;transform:translateX(-50%);bottom:160px;max-width:240px;background:linear-gradient(135deg,rgba(192,132,252,.95),rgba(96,165,250,.95));color:#0b0f16;border-radius:14px;padding:10px 12px;font-weight:800;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;box-shadow:0 8px 20px rgba(0,0,0,.25)}
  .assistant-bubble.show{opacity:1;transform:translate(-50%,-6px)}
  .assistant-bubble:after{content:"";position:absolute;left:50%;bottom:-10px;transform:translateX(-50%);border:10px solid transparent;border-top-color:rgba(192,132,252,.95)}
  .assistant-footer{display:flex;gap:8px;justify-content:center}
  .mini{font-size:.8rem;padding:6px 8px;border-radius:10px;border:1px solid var(--border);background:#10182a;color:#dbe5ff;cursor:pointer}
</style>
</head>
<body>
<header>Surgical Session Planner</header>

<div class="layout">
  <aside class="side">
    <button class="tab active" data-tab="builderTab">Builder</button>
    <button class="tab" data-tab="matcherTab">Requirement Matcher</button>

    <div class="assistant">
      <div class="assistant-bubble" id="assistBubble">Hi! Hover any control for tips.</div>
      <div class="assistant-avatar" id="bot">
        <!-- SVG FACE -->
        <svg id="botSvg" viewBox="0 0 200 200" width="150" height="150" aria-hidden="true">
          <!-- halo -->
          <defs>
            <linearGradient id="ring" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0" stop-color="#c084fc"/>
              <stop offset="1" stop-color="#60a5fa"/>
            </linearGradient>
            <radialGradient id="faceGrad" cx="50%" cy="40%" r="70%">
              <stop offset="0%" stop-color="#f8f3ff"/>
              <stop offset="100%" stop-color="#dbe1ff"/>
            </radialGradient>
          </defs>
          <circle cx="100" cy="100" r="86" fill="none" stroke="url(#ring)" stroke-width="8" opacity=".55"></circle>

          <!-- head group to move slightly -->
          <g id="head" transform="translate(0,0)">
            <!-- face -->
            <ellipse cx="100" cy="110" rx="62" ry="58" fill="url(#faceGrad)" stroke="#2b3654" stroke-width="2"></ellipse>

            <!-- eyes -->
            <g id="eyes">
              <g id="eyeL">
                <ellipse cx="78" cy="108" rx="18" ry="16" fill="#0b0f16" stroke="#4c5a84" stroke-width="3"></ellipse>
                <circle id="pupilL" cx="78" cy="108" r="6" fill="#ffffff"></circle>
              </g>
              <g id="eyeR">
                <ellipse cx="122" cy="108" rx="18" ry="16" fill="#0b0f16" stroke="#4c5a84" stroke-width="3"></ellipse>
                <circle id="pupilR" cx="122" cy="108" r="6" fill="#ffffff"></circle>
              </g>
              <!-- lids -->
              <rect id="lidL" x="60" y="92" width="36" height="0" fill="#e6ecff"></rect>
              <rect id="lidR" x="104" y="92" width="36" height="0" fill="#e6ecff"></rect>
            </g>

            <!-- brows -->
            <g id="brows" stroke="#2b3654" stroke-linecap="round" stroke-width="6">
              <path id="browL" d="M60 90 Q78 80 96 86"></path>
              <path id="browR" d="M104 86 Q122 80 140 90"></path>
            </g>

            <!-- mouth (path edited for expressions) -->
            <path id="mouth" d="M76 134 Q100 142 124 134" stroke="#2b3654" stroke-width="6" fill="none" stroke-linecap="round"></path>

            <!-- blush -->
            <ellipse cx="68" cy="128" rx="10" ry="6" fill="#ffc1cc" opacity=".35"></ellipse>
            <ellipse cx="132" cy="128" rx="10" ry="6" fill="#ffc1cc" opacity=".35"></ellipse>
          </g>
        </svg>
      </div>
      <div class="assistant-footer">
        <button class="mini" id="assistTipBuild">How to build</button>
        <button class="mini" id="assistTipMatch">How to match</button>
      </div>
    </div>
  </aside>

  <main>
    <section id="builderTab" class="stack">
      <div class="card stack">
        <h2>Create Mapping</h2>
        <div class="grid2">
          <label>Specialty
            <select id="specialty">
              <option value="" disabled selected>Select Specialty</option>
              <option>Applies to All</option><option>ENT</option><option>OMFS</option><option>Orthopaedics</option><option>Plastics</option><option>Neurosurgery</option><option>Renal</option><option>Vascular</option><option>Pain</option><option>Ophthalmology</option><option>Gynaecology</option><option>Urology</option><option>Colorectal</option><option>UGI</option><option>HPB</option><option>Endoscopy</option><option>Anaesthetics</option>
            </select>
          </label>
          <label>Requirement
            <select id="requirement">
              <option value="" disabled selected>Select Requirement</option>
              <option>Laser RN</option><option>Extra Scrub RN/ODP</option><option>Cell Salvage RN/ODP</option><option>Floater</option><option>Change list order</option><option>In-patient bed</option><option>2 cases in AM</option><option>8 cases in 2 sessions</option><option>No Need for Extra RN</option><option>4 hours duration</option><option>6 hours duration</option><option>Requires ENT nurse</option><option>Implant Review</option><option>Extra Robotic RN</option>
            </select>
          </label>
        </div>
        <div class="stack">
          <div class="chips" id="chipBox">
            <input id="chipInput" class="chip-input" type="text" placeholder="Type a keyword and press Enter" />
          </div>
          <div class="row">
            <button class="btn" id="saveMapping">Save mapping</button>
            <button class="btn secondary" id="resetForm" type="button">Clear</button>
            <span class="pill" id="editHint"></span>
          </div>
        </div>
      </div>

      <div class="card stack">
        <div class="row" style="justify-content:space-between">
          <h2>Mappings</h2>
          <div class="row">
            <input type="text" id="mapFilter" placeholder="Filter requirement or keyword" />
            <span class="pill" id="mapCount">0</span>
          </div>
        </div>
        <div class="table-wrap">
          <table id="mapTable">
            <colgroup><col style="width:240px"><col><col style="width:170px"></colgroup>
            <thead>
              <tr><th>Specialty</th><th>Requirement / Keywords</th><th>Actions</th></tr>
            </thead>
          </table>
        </div>
        <span class="pill">Click a specialty to expand or collapse.</span>
      </div>
    </section>

    <section id="matcherTab" class="stack" style="display:none">
      <div class="card stack">
        <h2>Paste or Type Description</h2>
        <textarea id="inputText" placeholder="Paste clinic/list details here…"></textarea>
        <div class="row">
          <button class="btn" id="runMatch">Match requirements</button>
          <button class="btn secondary" id="clearText" type="button">Clear</button>
          <span class="pill" id="matchCount">0 matches</span>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <h2>Highlighted Text</h2>
          <div id="highlight">No text yet.</div>
        </div>
        <div class="card">
          <h2>Inferred Requirements</h2>
          <div id="results">Nothing matched yet.</div>
        </div>
      </div>
    </section>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQW7EokI7uns6X9jxQnvIWX0SvDU68218",
    authDomain: "session-planner-1ef14.firebaseapp.com",
    projectId: "session-planner-1ef14",
    storageBucket: "session-planner-1ef14.firebasestorage.app",
    messagingSenderId: "17833265107",
    appId: "1:17833265107:web:3889ae3e98bbe45f98d126",
    measurementId: "G-J74KX24JP7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (q, r=document) => r.querySelector(q);
  const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));
  const mappingsRef = collection(db, 'mappings');

  let mappings = [];
  let editId = null;
  let chipValues = [];

  /* ---------- Assistant logic (no external libs) ---------- */
  const bubble = $('#assistBubble');
  const botSvg = $('#botSvg');
  const head = $('#head');
  const pupilL = $('#pupilL');
  const pupilR = $('#pupilR');
  const lidL = $('#lidL');
  const lidR = $('#lidR');
  const mouth = $('#mouth');
  const browL = $('#browL');
  const browR = $('#browR');

  function showBubble(msg){ bubble.textContent = msg; bubble.classList.add('show'); clearTimeout(showBubble._t); showBubble._t = setTimeout(()=> bubble.classList.remove('show'), 2100); }

  function setMouth(path){ mouth.setAttribute('d', path); }
  function setBrows(l, r){ browL.setAttribute('d', l); browR.setAttribute('d', r); }

  function faceIdle(){
    setMouth('M74 132 Q100 140 126 132');
    setBrows('M60 90 Q78 80 96 86','M104 86 Q122 80 140 90');
    lidL.setAttribute('height','0'); lidR.setAttribute('height','0');
  }
  function faceHappy(){
    setMouth('M72 134 Q100 154 128 134 Q100 150 72 134');
    setBrows('M58 86 Q78 76 96 82','M104 82 Q122 76 142 86');
  }
  function faceThink(){
    setMouth('M84 136 Q100 130 116 136');
    setBrows('M60 88 Q80 92 96 88','M104 88 Q120 92 140 88');
  }
  function faceWarn(){
    setMouth('M78 134 Q100 126 122 134');
    setBrows('M58 90 Q78 98 96 94','M104 94 Q122 98 142 90');
  }

  // Blink loop
  function blink(){
    lidL.setAttribute('height','0'); lidR.setAttribute('height','0');
    setTimeout(()=>{ lidL.setAttribute('height','30'); lidR.setAttribute('height','30'); }, 60);
    setTimeout(()=>{ lidL.setAttribute('height','0'); lidR.setAttribute('height','0'); }, 160);
  }
  setInterval(()=>{ blink(); }, 3200 + Math.random()*1200);

  // Pupils track cursor
  document.addEventListener('mousemove', e => {
    const b = botSvg.getBoundingClientRect();
    const cx = b.left + b.width/2, cy = b.top + b.height*0.55;
    const dx = Math.max(-1, Math.min(1, (e.clientX - cx) / (b.width/2)));
    const dy = Math.max(-1, Math.min(1, (e.clientY - cy) / (b.height/3)));
    const offx = dx*6, offy = dy*5;
    pupilL.setAttribute('cx', 78 + offx);
    pupilL.setAttribute('cy', 108 + offy);
    pupilR.setAttribute('cx', 122 + offx);
    pupilR.setAttribute('cy', 108 + offy);
    head.setAttribute('transform', `translate(${dx*2},${dy*2})`);
  });

  // Talk animation: cycle mouth path
  let talkTimer = null;
  function talk(msg){
    if(msg) showBubble(msg);
    if(talkTimer) clearInterval(talkTimer);
    let i=0;
    talkTimer = setInterval(()=>{
      const shapes = [
        'M88 136 Q100 136 112 136',
        'M80 134 Q100 146 120 134',
        'M86 138 Q100 132 114 138',
        'M78 134 Q100 152 122 134'
      ];
      setMouth(shapes[i%shapes.length]);
      i++;
    }, 120);
    setTimeout(()=>{ clearInterval(talkTimer); faceIdle(); }, 1800);
  }

  /* ---------- App logic ---------- */
  function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}
  function buildPluralRegex(keyword){
    const words=String(keyword).trim().split(/\s+/).filter(Boolean);
    const parts=words.map(w=>{
      const e=escapeRegExp(w);
      if(/y$/i.test(w)){const stem=escapeRegExp(w.slice(0,-1));return `(?:${stem}y|${stem}ies)`}
      if(/(s|x|ch|sh|z)$/i.test(w))return `(?:${e}|${e}es)`;
      return `(?:${e}|${e}s)`;
    });
    return new RegExp(`\\b${parts.join("\\s+")}\\b`,'gi');
  }

  function renderChips(){
    const box=$('#chipBox'); const input=$('#chipInput');
    box.innerHTML='';
    chipValues.forEach((v,i)=>{
      const el=document.createElement('span');
      el.className='chip';
      el.innerHTML=`<span>${v}</span><span class="x" data-i="${i}">×</span>`;
      box.appendChild(el);
    });
    box.appendChild(input);
    $$('.chip .x',box).forEach(x=>x.onclick=()=>{chipValues.splice(parseInt(x.dataset.i,10),1);renderChips()});
  }
  function addChipFromInput(){
    const v=$('#chipInput').value.trim();
    if(!v)return;
    v.split(',').map(s=>s.trim()).filter(Boolean).forEach(s=>{if(!chipValues.includes(s))chipValues.push(s)});
    $('#chipInput').value=''; renderChips();
  }
  $('#chipInput').addEventListener('keydown',e=>{
    if(e.key==='Enter'||e.key===','){e.preventDefault();addChipFromInput()}
    if(e.key==='Backspace'&&!e.currentTarget.value&&chipValues.length){chipValues.pop();renderChips()}
  });
  $('#chipInput').addEventListener('blur',addChipFromInput);
  renderChips();

  function groupBySpecialty(list){
    const g={}; list.forEach(m=>{const s=m.specialty||'Applies to All'; g[s] ||= []; g[s].push(m)});
    return Object.keys(g).sort((a,b)=>a.localeCompare(b)).map(s=>({specialty:s,items:g[s]}));
  }

  function renderTable(){
    const q=$('#mapFilter')?.value?.trim()?.toLowerCase()||'';
    let data=mappings.slice();
    if(q) data=data.filter(m=>(m.requirement||'').toLowerCase().includes(q)||(m.keywords||[]).some(k=>String(k).toLowerCase().includes(q)));
    $('#mapCount').textContent=data.length;
    const groups=groupBySpecialty(data);
    $$('#mapTable tbody').forEach(tb=>tb.remove());
    const table=$('#mapTable');
    groups.forEach(grp=>{
      const headTbody=document.createElement('tbody');
      const trG=document.createElement('tr');
      trG.className='grp';
      trG.dataset.specialty=grp.specialty;
      trG.innerHTML=`<td colspan="3"><span class="caret"></span>${grp.specialty} (${grp.items.length})</td>`;
      headTbody.appendChild(trG);
      table.appendChild(headTbody);

      const sub=document.createElement('tbody');
      sub.className='subrows';
      sub.dataset.parent=grp.specialty;

      grp.items.forEach(item=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td></td><td><div style="font-weight:900">${item.requirement}</div><div style="opacity:.85">${(item.keywords||[]).join(', ')}</div></td><td class="actions"><button class="btn secondary" data-edit="${item.id}" type="button">Edit</button><button class="btn secondary" data-del="${item.id}" type="button">Delete</button></td>`;
        sub.appendChild(tr);
      });
      table.appendChild(sub);
    });

    $$('#mapTable .grp').forEach(r=>{
      r.onclick=()=>{
        r.classList.toggle('open');
        const spec=r.dataset.specialty;
        const sub= $(`#mapTable tbody.subrows[data-parent="${CSS.escape(spec)}"]`);
        if(sub) sub.classList.toggle('open');
      };
    });

    $$('#mapTable button[data-del]').forEach(b=>b.onclick=async e=>{
      e.stopPropagation();
      await deleteDoc(doc(db,'mappings',b.dataset.del));
      faceWarn(); talk('Deleted.');
    });

    $$('#mapTable button[data-edit]').forEach(b=>b.onclick=e=>{
      e.stopPropagation();
      const m=mappings.find(x=>x.id===b.dataset.edit);
      if(!m)return;
      $('#specialty').value=m.specialty||'';
      $('#requirement').value=m.requirement||'';
      chipValues=(m.keywords||[]).slice();
      renderChips();
      editId=m.id;
      $('#saveMapping').textContent='Update mapping';
      $('#editHint').textContent=`Editing ${m.specialty} — ${m.requirement}`;
      faceThink(); showBubble('Editing mapping…');
    });
  }

  $('#mapFilter')?.addEventListener('input',renderTable);

  $('#saveMapping').onclick=async()=>{
    const specialty=$('#specialty').value.trim();
    const requirement=$('#requirement').value.trim();
    const keywords=chipValues.slice();
    if(!specialty||!requirement||!keywords.length){faceWarn(); showBubble('Please complete all fields and add a keyword.'); return}
    if(editId){
      await updateDoc(doc(db,'mappings',editId),{specialty,requirement,keywords});
      editId=null; $('#saveMapping').textContent='Save mapping'; $('#editHint').textContent='';
    }else{
      await addDoc(mappingsRef,{specialty,requirement,keywords});
    }
    chipValues=[]; renderChips();
    faceHappy(); talk('Saved!');
  };

  $('#resetForm').onclick=()=>{
    editId=null; $('#specialty').selectedIndex=0; $('#requirement').selectedIndex=0;
    chipValues=[]; renderChips(); $('#saveMapping').textContent='Save mapping'; $('#editHint').textContent='';
    faceIdle();
  };

  onSnapshot(mappingsRef,snap=>{
    mappings=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderTable();
  });

  function runMatch(){
    const raw=$('#inputText').value;
    if(!raw.trim()){faceWarn(); showBubble('Paste some text first');return}
    const text=raw;
    const findings=[]; const hits=new Set();
    mappings.forEach(m=>{
      const local=[];
      (m.keywords||[]).forEach(k=>{
        const re=buildPluralRegex(String(k));
        if(re.test(text)){local.push(k);hits.add(k);re.lastIndex=0}
      });
      if(local.length) findings.push({specialty:m.specialty,requirement:m.requirement,hits:local});
    });
    findings.sort((a,b)=>a.specialty.localeCompare(b.specialty)||a.requirement.localeCompare(b.requirement));
    let highlighted=text;
    Array.from(hits).sort((a,b)=>b.length-a.length).forEach(k=>{
      const re=buildPluralRegex(k);
      highlighted=highlighted.replace(re,m=>`<mark>${m}</mark>`);
    });
    $('#highlight').innerHTML=highlighted||'No text yet.';
    $('#matchCount').textContent=`${findings.length} match${findings.length===1?'':'es'}`;
    if(!findings.length){$('#results').innerHTML='<span style="opacity:.85">No requirements inferred.</span>'; talk('No matches yet — try adding more keywords.'); return}
    $('#results').innerHTML=findings.map(r=>{
      const h=r.hits.map(x=>`<span class="pill">${x}</span>`).join(' ');
      return `<div style="margin-bottom:10px"><strong>${r.specialty}</strong> — ${r.requirement}<div class="row" style="margin-top:6px">${h}</div></div>`;
    }).join('');
    faceHappy(); talk(`Found ${findings.length} matches!`);
  }

  $('#runMatch').onclick=runMatch;
  $('#clearText').onclick=()=>{$('#inputText').value='';$('#highlight').textContent='No text yet.';$('#results').textContent='Nothing matched yet.';$('#matchCount').textContent='0 matches'; faceIdle();};

  $$('.side .tab').forEach(btn=>btn.onclick=()=>{
    $$('.side .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    $('#builderTab').style.display=btn.dataset.tab==='builderTab'?'grid':'none';
    $('#matcherTab').style.display=btn.dataset.tab==='matcherTab'?'grid':'none';
    talk(btn.dataset.tab==='builderTab'?'Create or edit mappings here.':'Paste text and press Match.');
  });

  // Hint buttons
  $('#assistTipBuild').onclick=()=>{ talk('Choose specialty, requirement, add keywords, then Save.'); };
  $('#assistTipMatch').onclick=()=>{ talk('Paste a list description and click Match to infer requirements.'); };

  // Start
  faceIdle();
</script>
</body>
</html>
